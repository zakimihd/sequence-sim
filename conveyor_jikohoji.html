<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>検定盤シミュレーション（自己保持＋LED点灯時停止＋PL走行点灯）</title>
<style>
  :root { --panel-max-width: 900px; }
  html, body { margin:0; height:100%; background:#0b0b0c; color:#e7e7e7; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; }
  .wrap { min-height:100%; display:grid; place-items:center; padding:16px; }

  .panel { position:relative; width:min(96vw, var(--panel-max-width)); }
  .panel > img { display:block; width:100%; height:auto; object-fit:contain; user-select:none; pointer-events:none; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,.45); }

  .layer { position:absolute; inset:0; pointer-events:none; }
  .hitbox, .work, .selector { pointer-events:auto; }

  .hitbox { position:absolute; transform:translate(-50%, -50%); background:transparent; border:none; cursor:pointer; z-index:50; }
  .belt { position:absolute; left:23%; right:24%; top:42.9%; height:8.2%; border-radius:8px; }
  .belt::before { content:""; position:absolute; inset:0; background: rgba(63,187,171,0.28); mix-blend-mode:screen; border-radius:inherit; }

  .work {
    position:absolute; width:14.3%; height:auto; top:42%; left:50%; transform:translate(-50%,0);
    border:1.5px solid #3a3d44; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,.45);
    z-index:20; cursor:grab; touch-action:none; user-select:none;
  }
  .work:active { cursor:grabbing; }

  /* LS画像をワークより前面へ */
  .ls { position:absolute; width:14.8%; height:auto; transform:translate(-50%,-50%); z-index:80; pointer-events:none; }

  /* ランプ（OFF時は透明） */
  .lamp {
    position:absolute; width:2.3%; aspect-ratio:1/1; transform:translate(-50%,-50%);
    border-radius:999px; background:#22c55e; opacity:0; box-shadow:none; z-index:42;
  }
  .lamp.on {
    opacity:1;
    box-shadow:0 0 10px #22c55e, 0 0 22px rgba(34,197,94,.75), 0 0 36px rgba(34,197,94,.45);
  }

  /* 高輝度LED（青） */
  .led-blue {
    position:absolute; width:1.2%; aspect-ratio:1/1; transform:translate(-50%,-50%);
    border-radius:0; background:#1f2a44;
    box-shadow:inset 0 0 4px rgba(0,0,0,.8);
    z-index:90; /* ★最前面へ */
  }
  .led-blue.on { background:#3abff8; box-shadow:0 0 12px #3abff8, 0 0 22px rgba(58,191,248,.85); }

  .ls-zone { position:absolute; transform:translate(-50%,-50%); width:7.5%; height:8%; z-index:25; pointer-events:none; }

  .selector { position:absolute; width:6.8%; height:auto; transform:translate(-50%,-50%); z-index:45; user-select:none; cursor:pointer; }
</style>
</head>
<body>
<main class="wrap">
  <section class="panel" id="panel">
    <img id="panelImage" src="panel2.png" alt="検定盤（実写）" />

    <div class="layer"><div class="belt" aria-hidden="true"></div></div>

    <!-- ワーク -->
    <div class="layer">
      <img id="work" class="work" src="work.png" alt="ワーク" draggable="false" />
    </div>

    <!-- LS画像（ワークより上） -->
    <div class="layer" aria-hidden="true">
      <img id="lsLeft"  class="ls" src="limit1.png" alt="左リミット"  style="left:66%; top:49%;" />
      <img id="lsRight" class="ls" src="limit2.png" alt="右リミット" style="left:33%; top:45%;" />
    </div>

    <!-- LSゾーン -->
    <div class="layer" aria-hidden="true">
      <div id="zoneLeft"  class="ls-zone" style="left:21%; top:48%;"></div>
      <div id="zoneRight" class="ls-zone" style="left:78%; top:48%;"></div>
    </div>

    <!-- 押しボタン -->
    <div class="layer">
      <button id="pb1" class="hitbox" style="left:30%; top:82%; width:6%; height:4%;"></button>
      <button id="pb2" class="hitbox" style="left:38%; top:82%; width:6%; height:4%;"></button>
    </div>

    <!-- 切替スイッチ -->
    <div class="layer">
      <img id="selector" class="selector" src="chang_l-removebg-preview.png" style="left:13.9%; top:82.8%;" draggable="false" />
      <img id="selector2" class="selector" src="chang_l-removebg-preview.png" style="left:21.9%; top:82.8%;" draggable="false" />
    </div>

    <!-- PL1・PL2 -->
    <div class="layer" aria-hidden="true">
      <div id="pl1" class="lamp" style="left:30%;  top:69.3%;"></div>
      <div id="pl2" class="lamp" style="left:37.8%; top:69.3%;"></div>
    </div>

    <!-- ★高輝度LED（最前面） -->
    <div class="layer" aria-hidden="true" style="z-index:90;">
      <div id="ls1Blue" class="led-blue" style="left:31%; top:46%;"></div>
      <div id="ls2Blue" class="led-blue" style="left:68%; top:46%;"></div>
    </div>
  </section>
</main>

<script>
/* ===== パラメータ ===== */
const beltLeftPct = 23, beltRightPct = 76, workWidthPct = 9, speedPctPerSec = 25;

/* ===== 要素取得 ===== */
const $ = s => document.querySelector(s);
const panel = $('#panel'), work = $('#work');
const pb1El = $('#pb1'), pb2El = $('#pb2');
const pl1El = $('#pl1'), pl2El = $('#pl2');
const ls1Blue = $('#ls1Blue'), ls2Blue = $('#ls2Blue');
const zoneLeft = $('#zoneLeft'), zoneRight = $('#zoneRight');

/* 切替スイッチ */
const selectorImg = $('#selector');
const selectorImg2 = $('#selector2');
const SWITCH_LEFT_IMG  = 'chang_l-removebg-preview.png';
const SWITCH_RIGHT_IMG = 'chang_r-removebg-preview.png';
[SWITCH_LEFT_IMG, SWITCH_RIGHT_IMG].forEach(src => { const i = new Image(); i.src = src; });

/* ===== 状態 ===== */
let pb1Pressed = false, pb2Pressed = false;
let workLeftPct = 50, dragging = false;
let moveMode = null;
let selector = 'left';
let selector2 = 'left';

/* ===== 関数群 ===== */
const minCenter = () => beltLeftPct + workWidthPct/2;
const maxCenter = () => beltRightPct - workWidthPct/2;
const clamp = (x, lo, hi) => Math.min(hi, Math.max(lo, x));
function placeWork(){ work.style.left = workLeftPct + '%'; }
function rectOf(el){ const r = el.getBoundingClientRect(); return {x:r.left, y:r.top, w:r.width, h:r.height}; }
function intersects(a,b){ return !(a.x+a.w<b.x||b.x+b.w<a.x||a.y+a.h<b.y||b.y+b.h<a.y); }

function updatePBText(){
  pl1El.classList.toggle('on', pb1Pressed);
  pl2El.classList.toggle('on', pb2Pressed);
}

/* ===== LS判定：LED点灯＆停止処理 ===== */
function updateLS(){
  const a = rectOf(work), l = rectOf(zoneLeft), r = rectOf(zoneRight);
  const L_on = intersects(a,l);
  const R_on = intersects(a,r);
  ls1Blue.classList.toggle('on', L_on);
  ls2Blue.classList.toggle('on', R_on);
  if (L_on || R_on) moveMode = null;
}

/* ===== 切替 ===== */
function renderSelector(){ selectorImg.src = (selector==='left')?SWITCH_LEFT_IMG:SWITCH_RIGHT_IMG; }
function renderSelector2(){ selectorImg2.src = (selector2==='left')?SWITCH_LEFT_IMG:SWITCH_RIGHT_IMG; }
function toggleSelector(){ selector=(selector==='left')?'right':'left'; renderSelector(); }
function toggleSelector2(){ selector2=(selector2==='left')?'right':'left'; renderSelector2(); }
selectorImg.addEventListener('pointerdown',e=>{e.preventDefault();toggleSelector();});
selectorImg2.addEventListener('pointerdown',e=>{e.preventDefault();toggleSelector2();});

/* ===== PB押下 ===== */
function press(which,down){
  if(which===1){ pb1Pressed=down; if(down) moveMode='left'; }
  if(which===2){ pb2Pressed=down; if(down) moveMode='right'; }
  updatePBText();
}
pb1El.addEventListener('pointerdown',()=>press(1,true));
pb1El.addEventListener('pointerup',()=>press(1,false));
pb1El.addEventListener('pointerleave',()=>press(1,false));
pb1El.addEventListener('pointercancel',()=>press(1,false));
pb2El.addEventListener('pointerdown',()=>press(2,true));
pb2El.addEventListener('pointerup',()=>press(2,false));
pb2El.addEventListener('pointerleave',()=>press(2,false));
pb2El.addEventListener('pointercancel',()=>press(2,false));

/* ===== キーボード ===== */
window.addEventListener('keydown',e=>{
  if(e.repeat) return;
  if(e.key==='c') press(1,true);
  if(e.key==='v') press(2,true);
  if(e.key.toLowerCase()==='x') toggleSelector();
});
window.addEventListener('keyup',e=>{
  if(e.key==='c') press(1,false);
  if(e.key==='v') press(2,false);
});

/* ===== ドラッグ ===== */
function pxToPct(clientX){
  const r=panel.getBoundingClientRect();
  const x=clamp(clientX,r.left,r.right);
  return((x-r.left)/r.width)*100;
}
work.addEventListener('pointerdown',e=>{
  dragging=true; work.setPointerCapture(e.pointerId);
  workLeftPct=clamp(pxToPct(e.clientX),minCenter(),maxCenter());
  placeWork(); updateLS();
});
work.addEventListener('pointermove',e=>{
  if(!dragging)return;
  workLeftPct=clamp(pxToPct(e.clientX),minCenter(),maxCenter());
  placeWork(); updateLS();
});
function endDrag(e){ if(!dragging)return; dragging=false; try{work.releasePointerCapture(e.pointerId);}catch(_){}} 
work.addEventListener('pointerup',endDrag);
work.addEventListener('pointercancel',endDrag);
work.addEventListener('pointerleave',endDrag);

/* ===== ループ ===== */
let rafId=null,lastT=0;
function loop(t){
  if(!lastT) lastT=t;
  const dt=(t-lastT)/1000; lastT=t;
  if(!dragging){
    let dir=0;
    if(moveMode==='left') dir=-1;
    else if(moveMode==='right') dir=+1;
    else{
      if(pb1Pressed&&!pb2Pressed) dir=-1;
      if(pb2Pressed&&!pb1Pressed) dir=+1;
    }

    /* 走行中ランプ制御 */
    if(dir<0){ pl1El.classList.add('on'); pl2El.classList.remove('on'); }
    else if(dir>0){ pl2El.classList.add('on'); pl1El.classList.remove('on'); }
    else{ pl1El.classList.remove('on'); pl2El.classList.remove('on'); }

    if(dir){
      workLeftPct=clamp(workLeftPct+dir*speedPctPerSec*dt,minCenter(),maxCenter());
      placeWork(); updateLS();
    }
  }
  rafId=requestAnimationFrame(loop);
}

/* ===== 起動 ===== */
renderSelector(); renderSelector2();
placeWork(); updatePBText(); updateLS();
rafId=requestAnimationFrame(loop);
</script>
</body>
</html>
