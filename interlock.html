<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>検定盤シミュレーション（インターロック：PL1/PL3相互排他・PB2でリセット）</title>
  <style>
    :root { --panel-max-width: 900px; }
    html, body {
      margin: 0; height: 100%;
      background: #0b0b0c; color: #e7e7e7;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
    }
    .wrap { min-height: 100%; display: grid; place-items: center; padding: 16px; }

    .panel { position: relative; width: min(96vw, var(--panel-max-width)); }
    .panel > img {
      display: block; width: 100%; height: auto; object-fit: contain;
      user-select: none; pointer-events: none;
      border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,.45);
    }

    .layer { position: absolute; inset: 0; }
    .indicators { pointer-events: none; }

    /* ランプ表示（丸） */
    .lamp { position: absolute; width: 5px; height: 5px; transform: translate(-50%, -50%); border-radius: 100px; transition: box-shadow .1s linear, background .1s linear, opacity .1s linear; }
    .lamp.on  { background: rgba(34, 197, 94, 0.95); box-shadow: 0 0 12px rgba(34, 197, 94, 0.95); }
    .lamp.off { background: rgba(212,212,212,0.55); box-shadow: none; }

    /* PBヒットボックス（透明ボタン） */
    .hitbox {
      position: absolute; transform: translate(-50%, -50%);
      background: transparent; border: none; cursor: pointer;
    }
    .hitbox.debug { background: rgba(14,165,233,0.12); outline: 2px solid rgba(14,165,233,0.7); }

    /* 下部バー */
    .bar {
      display:flex; gap: 12px; align-items:center; justify-content:space-between;
      width:min(96vw, var(--panel-max-width)); margin: 10px auto 0;
      font-size: 14px; color:#cfcfcf;
      flex-wrap: wrap;
    }
    .bar label { display:flex; align-items:center; gap:.5em; font-size: 13px; opacity:.9 }
    .kbd { background:#16181d; border:1px solid #2a2d34; padding:2px 6px; border-radius:6px; font-size: 12px; }
    .status { display:flex; gap: 12px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="panel" id="panel">
      <!-- 同じフォルダに panel.png を置いてください -->
      <img id="panelImage" src="./panel.png" alt="検定盤（実写）" />

      <!-- 表示レイヤ（PL1, PL3） -->
      <div class="layer indicators">
        <div id="pl1" class="lamp off" title="PL1（PB1で保持）"></div>
        <div id="pl3" class="lamp off" title="PL3（PB3で保持）"></div>
      </div>

      <!-- クリックレイヤ（PB1, PB2, PB3） -->
      <div class="layer" id="inputs">
        <button id="pb1" class="hitbox" title="PB1（PL1を保持）" aria-label="PB1"></button>
        <button id="pb2" class="hitbox" title="PB2（リセット：全消灯）" aria-label="PB2"></button>
        <button id="pb3" class="hitbox" title="PB3（PL3を保持）" aria-label="PB3"></button>
      </div>
    </section>

    <div class="bar">
      <div class="status">
        PB1: <span id="pb1State">OFF</span>／
        PB2: <span id="pb2State">OFF</span>／
        PB3: <span id="pb3State">OFF</span>／
        PL1: <span id="pl1State">消灯</span>／
        PL3: <span id="pl3State">消灯</span>／
        MODE: <span id="modeState">待機</span>
      </div>
      <div>
        操作: PB1=<span class="kbd">C</span> ／ PB2=<span class="kbd">V</span>（リセット） ／ PB3=<span class="kbd">B</span>
      </div>
      <label><input type="checkbox" id="toggleDebug" /> ヒットボックス表示</label>
    </div>
  </main>

  <script>
    // === 位置（%）: 既存PB1/PL1/PB2はそのまま。PB3/PL3を右側に仮配置 ===
    const POS = {
      pl1: { left: 30, top: 69.5, size: 2 },     // 既存
      pb1: { left: 30, top: 82.0, width: 6, height: 4 }, // 既存
      pb2: { left: 38.0, top: 82.0, width: 6, height: 4 }, // 既存（リセット）
      pl3: { left: 45.5, top: 69.5, size: 2 },     // 追加（仮）
      pb3: { left: 46.0, top: 82.0, width: 6, height: 4 }, // 追加（仮）
    };

    const $ = (sel) => document.querySelector(sel);
    const pl1El = $('#pl1');
    const pl3El = $('#pl3');
    const pb1El = $('#pb1');
    const pb2El = $('#pb2');
    const pb3El = $('#pb3');
    const pb1State = $('#pb1State');
    const pb2State = $('#pb2State');
    const pb3State = $('#pb3State');
    const pl1State = $('#pl1State');
    const pl3State = $('#pl3State');
    const modeState = $('#modeState');
    const debugSwitch = $('#toggleDebug');

    function applyPositions() {
      // PL1
      pl1El.style.left = POS.pl1.left + '%';
      pl1El.style.top  = POS.pl1.top  + '%';
      pl1El.style.width  = POS.pl1.size + '%';
      pl1El.style.height = POS.pl1.size + '%';
      // PB1
      pb1El.style.left = POS.pb1.left + '%';
      pb1El.style.top  = POS.pb1.top  + '%';
      pb1El.style.width  = POS.pb1.width + '%';
      pb1El.style.height = POS.pb1.height + '%';
      // PB2
      pb2El.style.left = POS.pb2.left + '%';
      pb2El.style.top  = POS.pb2.top  + '%';
      pb2El.style.width  = POS.pb2.width + '%';
      pb2El.style.height = POS.pb2.height + '%';
      // PL3
      pl3El.style.left = POS.pl3.left + '%';
      pl3El.style.top  = POS.pl3.top  + '%';
      pl3El.style.width  = POS.pl3.size + '%';
      pl3El.style.height = POS.pl3.size + '%';
      // PB3
      pb3El.style.left = POS.pb3.left + '%';
      pb3El.style.top  = POS.pb3.top  + '%';
      pb3El.style.width  = POS.pb3.width + '%';
      pb3El.style.height = POS.pb3.height + '%';
    }

    // 入力表示用
    let pb1Pressed = false, pb2Pressed = false, pb3Pressed = false;

    // 相互排他的な保持状態: 0=消灯, 1=PL1保持, 3=PL3保持
    let activeLamp = 0;

    function applyLamp() {
      const l1 = activeLamp === 1;
      const l3 = activeLamp === 3;
      pl1El.classList.toggle('on', l1);
      pl1El.classList.toggle('off', !l1);
      pl3El.classList.toggle('on', l3);
      pl3El.classList.toggle('off', !l3);
      pl1State.textContent = l1 ? '点灯（保持）' : '消灯';
      pl3State.textContent = l3 ? '点灯（保持）' : '消灯';
      modeState.textContent = activeLamp === 0 ? '待機' : (activeLamp === 1 ? 'PL1保持中（インターロック）' : 'PL3保持中（インターロック）');
    }

    function updatePBText() {
      pb1State.textContent = pb1Pressed ? 'ON（押下中）' : 'OFF';
      pb2State.textContent = pb2Pressed ? 'ON（押下中）' : 'OFF';
      pb3State.textContent = pb3Pressed ? 'ON（押下中）' : 'OFF';
    }

    // 押下処理（which: 1=PB1, 2=PB2, 3=PB3）
    function pressPB(which, pressed) {
      if (which === 1) pb1Pressed = pressed;
      if (which === 2) pb2Pressed = pressed;
      if (which === 3) pb3Pressed = pressed;
      updatePBText();

      if (pressed) {
        if (which === 2) {
          // リセット（常に有効）
          activeLamp = 0;
          applyLamp();
          return;
        }
        if (which === 1) {
          // PL1を保持：空きのときのみ
          if (activeLamp === 0) {
            activeLamp = 1;
            applyLamp();
          }
          return;
        }
        if (which === 3) {
          // PL3を保持：空きのときのみ
          if (activeLamp === 0) {
            activeLamp = 3;
            applyLamp();
          }
          return;
        }
      }
    }

    // ポインタイベント
    pb1El.addEventListener('pointerdown', () => pressPB(1, true));
    pb1El.addEventListener('pointerup',   () => pressPB(1, false));
    pb1El.addEventListener('pointerleave',() => pressPB(1, false));
    pb1El.addEventListener('pointercancel',() => pressPB(1, false));

    pb2El.addEventListener('pointerdown', () => pressPB(2, true));
    pb2El.addEventListener('pointerup',   () => pressPB(2, false));
    pb2El.addEventListener('pointerleave',() => pressPB(2, false));
    pb2El.addEventListener('pointercancel',() => pressPB(2, false));

    pb3El.addEventListener('pointerdown', () => pressPB(3, true));
    pb3El.addEventListener('pointerup',   () => pressPB(3, false));
    pb3El.addEventListener('pointerleave',() => pressPB(3, false));
    pb3El.addEventListener('pointercancel',() => pressPB(3, false));

    // キーボード：PB1=C、PB2=V（リセット）、PB3=B
    window.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      if (e.key === 'c') pressPB(1, true);
      if (e.key === 'v') pressPB(2, true);
      if (e.key === 'b') pressPB(3, true);
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'c') pressPB(1, false);
      if (e.key === 'v') pressPB(2, false);
      if (e.key === 'b') pressPB(3, false);
    });

    // フォーカス喪失時：押下表示のみ解除（保持状態は維持）
    window.addEventListener('blur', () => {
      pb1Pressed = pb2Pressed = pb3Pressed = false;
      updatePBText();
    });

    // デバッグ（ヒットボックス可視化）
    const toggleDebug = () => {
      const on = debugSwitch.checked;
      pb1El.classList.toggle('debug', on);
      pb2El.classList.toggle('debug', on);
      pb3El.classList.toggle('debug', on);
    };
    debugSwitch.addEventListener('change', toggleDebug);

    // 初期化
    applyPositions();
    applyLamp();
    updatePBText();
  </script>
</body>
</html>
